parameters:
  - name: 'PoolName'
    default: ''
    type: string
  - name: 'TargetOs'
    default: 'ltsc2019'
    type: string
  - name: 'Sitecore_Version'
    default: ''
    type: string
  - name: 'OsTest'
    default: OSOSOS
    type: string
  - name: 'EnvName'
    type: string
    default: 'preProd'

variables:
- name: sitecoreVersion
  value: ${{ parameters.Sitecore_Version }}
- name: targetOsName
  value: ${{ parameters.TargetOs }}
- name: testEnv
  ${{ if eq(parameters['EnvName'], 'preProd') }}:
    value: 'yes'
  ${{ if ne(parameters['EnvName'], 'preProd') }}:
    value: 'not'
- name: Os_Test
  ${{ if eq(parameters.OsTest, 'OSOSOS') }}:
    value: 'equal'
  ${{ if not(eq(parameters.OsTest, 'OSOSOS')) }}:
    value: 'not equal'
- name: osNameTest
  ${{ if eq('${{ parameters.TargetOs }}', 'ltsc2022') }}:
    value: 'equal'
  ${{ else }}:
    value: 'not equal' 
- name: buildNumber
  value: $(Build.BuildID)
- name: azureContainerRegistry
  value: $(ACR_ContainerRegistry)
- name: azureSubscriptionEndpoint
  value: AKSServiceConnections
- ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
  - name: stability
    value: ''
  - name: namespace
    value: 'tools'
- ${{ if ne(variables['Build.SourceBranchName'], 'main') }}:
  - name: stability
    value: '-unstable'
  - name: namespace
    value: 'experimental'
- name: revision
  value: $[counter(format('sitecoreVersion{0}', variables['sitecoreVersion']), 100)]
- ${{ if eq(variables['targetOsName'], 'ltsc2022') }}:
  - name: osName
    value: '12345'   
- name: Os_Test1
  ${{ if eq('parameters.TargetOs', 'ltsc2022') }}:
    value: '1'
  ${{ else }}:
    value: '2'

stages:
- stage: Versioning

  jobs:
  - job: Tagging
    pool:
      name: ${{ parameters.PoolName }}
    steps:
    
    - task: PowerShell@2
      name: Tags
      displayName: Generate tags
      inputs:
        targetType: 'inline'
        script: |
            Write-Host "Os_Test1 = $(Os_Test1)"
            Write-Host "targetOsName = $(targetOsName)"
            Write-Host "EnvName is ${{ parameters['EnvName'] }}..."
            Write-Host "testEnv is $(testEnv)..."
            Write-Host "stability is $(stability)..."
            Write-Host "namespace is $(namespace)..."
            Write-Host "OsTest is ${{ parameters.OsTest }}..."
            Write-Host "Os_Test is $(Os_Test)..."
            Write-Host "PoolName is ${{ parameters.PoolName }}..."
            Write-Host "TargetOs is ${{ parameters.TargetOs }}..."
            Write-Host "Sitecore_Version is ${{ parameters.Sitecore_Version }}..."
            Write-Host "sitecoreVersion is $(sitecoreVersion)..."
            Write-Host "osNameTest is $(osNameTest)..."
            Write-Host "osName is $(osName)..."
            
            
            
            

            Write-Host "Pulling base image $(baseImage)..."
            docker pull $(baseImage)

            [string] $osVersion = (docker image inspect $(baseImage) | ConvertFrom-Json).OsVersion
            Write-Host "Image OS version is '$osVersion'"

            [string] $longTag = "$(sitecoreVersion).$(revision).$(buildNumber)-$osVersion-$(osName)$(stability)"
            [string] $shortTag = "$(sitecoreVersion)-$(osName)$(stability)"
            Write-Host "Setting long tag to '$longTag'"
            Write-Host "Setting short tag to '$shortTag'"
            Write-Host "##vso[task.setvariable variable=longTag;isOutput=true]$longTag"
            Write-Host "##vso[task.setvariable variable=shortTag;isOutput=true]$shortTag"
            
- stage: Build
  dependsOn: Versioning

  jobs:
  - job: Build
    pool:
      name: ${{ parameters.PoolName }}
    displayName: Build image
    variables:
      longTag: $[stageDependencies.Versioning.Tagging.outputs['Tags.longTag']]
      shortTag: $[stageDependencies.Versioning.Tagging.outputs['Tags.shortTag']]
    steps:
    
    - task: DockerCompose@0
      displayName: Building image
      inputs:
        containerregistrytype: Azure Container Registry
        azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
        azureContainerRegistry: $(azureContainerRegistry)
        dockerComposeFile: '**/docker-compose.yml'
        dockerComposeFileArgs: |
          REGISTRY=$(azureContainerRegistry)/$(namespace)/
          VERSION=$(longTag)
          BASE_IMAGE=$(baseImage)
          BUILD_IMAGE=$(buildImage)
        action: Build services
        additionalImageTags: '$(shortTag)'
        arguments: '--force-rm'
        currentWorkingDirectory: '$(Build.SourcesDirectory)/image/src'

- stage: Test
  dependsOn: Build

  jobs:
  - job: Pester
    pool:
      name: ${{ parameters.PoolName }}
    displayName: Run Pester tests
    steps:

    - task: Pester@9
      inputs:
        scriptFolder: "$(Build.SourcesDirectory)/image/test/*"
        resultsFile: "$(Build.SourcesDirectory)/image/test/Test-Pester.XML"
        usePSCore: False
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: "NUnit"
        testResultsFiles: "$(Build.SourcesDirectory)/image/test/Test-Pester.XML"
        failTaskOnFailedTests: true
        
- stage: Push
  dependsOn:
  - Versioning
  - Test
  condition: ne(variables['Build.Reason'], 'PullRequest')

  jobs:
  - job: Push
    pool:
      name: ${{ parameters.PoolName }}
    displayName: Push image
    variables:
      longTag: $[stageDependencies.Versioning.Tagging.outputs['Tags.longTag']]
      shortTag: $[stageDependencies.Versioning.Tagging.outputs['Tags.shortTag']]
    steps:

    - task: DockerCompose@0
      displayName: Pushing image
      inputs:
        containerregistrytype: Azure Container Registry
        azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
        azureContainerRegistry: $(azureContainerRegistry)
        dockerComposeFile: '**/docker-compose.yml'
        dockerComposeFileArgs: |
          REGISTRY=$(azureContainerRegistry)/$(namespace)/
          VERSION=$(longTag)
          BASE_IMAGE=$(baseImage)
          BUILD_IMAGE=$(buildImage)
        action: Push services
        additionalImageTags: '$(shortTag)'
        currentWorkingDirectory: '$(Build.SourcesDirectory)/image/src'